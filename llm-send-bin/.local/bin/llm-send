#!/usr/bin/env bash
set -euo pipefail

# Get AI pane target from window-scoped tmux user options
# Prefer stable pane ID (@AI_PANE_ID), fall back to legacy index (@AI_PANE)
AI_PANE_ID=""
AI_PANE=""
PROMPT_PANE="" # Needed for the gemini strategy
if [ -n "${TMUX_PANE:-}" ]; then
  # Get session and window from current pane
  _session=$(tmux display-message -t "${TMUX_PANE}" -p '#S' 2>/dev/null)
  _window=$(tmux display-message -t "${TMUX_PANE}" -p '#I' 2>/dev/null)

  if [ -n "$_session" ] && [ -n "$_window" ]; then
    # Retrieve window-scoped user options (prefer pane IDs)
    AI_PANE_ID=$(tmux show-option -wv -t "$_session:$_window" @AI_PANE_ID 2>/dev/null) || true
    AI_PANE=$(tmux show-option -wv -t "$_session:$_window" @AI_PANE 2>/dev/null) || true
    PROMPT_PANE=$(tmux show-option -wv -t "$_session:$_window" @PROMPT_PANE 2>/dev/null) || true
    AI_TOOL=$(tmux show-option -wv -t "$_session:$_window" @AI_TOOL 2>/dev/null) || true
  fi
fi

# Prefer stable pane ID, fall back to legacy index, then next pane
TARGET="${AI_PANE_ID:-${AI_PANE:-:.+}}"

IS_COMMAND=false
INPUT_FILE=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -c|--command)
      IS_COMMAND=true
      shift
      ;;
    *)
      INPUT_FILE="$1"
      shift
      ;;
  esac
done

# Read content from file arg or stdin
CONTENT=""
if [ -n "$INPUT_FILE" ]; then
  CONTENT=$(cat "$INPUT_FILE")
else
  CONTENT=$(cat -)
fi

# CRITICAL: Exit copy-mode if pane is scrolled up
tmux send-keys -t "$TARGET" -X cancel 2>/dev/null || true

if [ "$IS_COMMAND" = true ]; then
  # Direct send strategy for slash commands
  tmux send-keys -t "$TARGET" "$CONTENT"
  tmux send-keys -t "$TARGET" Enter
  exit 0
fi

# Construct complete message with markers and content as single string
TIMESTAMP=$(date +'%F %T')
COMPLETE_MESSAGE="### PROMPT ${TIMESTAMP}

${CONTENT}

### END PROMPT"

# CRITICAL: Exit copy-mode if pane is scrolled up
tmux send-keys -t "$TARGET" -X cancel 2>/dev/null || true

case "$AI_TOOL" in
  gemini)
    # Gemini strategy: Use external editor with system clipboard paste
    # 1. Send Ctrl-x to open external editor in the AI pane
    tmux send-keys -t "$TARGET" C-x
    sleep 0.5 # Optimized sleep time

    # 2. Copy the content to the system clipboard and paste in vim
    if command -v wl-copy &>/dev/null; then
      echo "$COMPLETE_MESSAGE" | wl-copy
    elif command -v xclip &>/dev/null; then
      echo "$COMPLETE_MESSAGE" | xclip -selection clipboard
    elif command -v pbcopy &>/dev/null; then
      echo "$COMPLETE_MESSAGE" | pbcopy
    else
      echo "Error: No clipboard tool found (need wl-copy, xclip, or pbcopy)" >&2
      exit 1
    fi
    tmux send-keys -t "$TARGET" '"+p'
    sleep 0.5 # Optimized sleep time

    # 3. Save and quit the editor (e.g., :wq)
    tmux send-keys -t "$TARGET" Escape
    tmux send-keys -t "$TARGET" ":wq" C-m
    sleep 0.5 # Optimized sleep time

    # 4. Send Enter to submit the prompt now in the Gemini CLI input
    tmux send-keys -t "$TARGET" Enter
    ;;
  *)
    # Default strategy: Paste from buffer (for Claude, etc.)
    # Load the complete message into tmux buffer
    echo "$COMPLETE_MESSAGE" | tmux load-buffer -

    # Paste the complete message (all newlines are part of the paste, not keypresses)
    tmux paste-buffer -t "$TARGET"

    # For large pastes, add a delay before sending Enter
    BUFFER_SIZE=$(tmux show-buffer | wc -c)
    if [ "$BUFFER_SIZE" -gt 1000 ]; then
      sleep 0.5
    fi

    # Send single Enter to submit the prompt
    tmux send-keys -t "$TARGET" Enter
    ;;
esac
